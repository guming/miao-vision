<!DOCTYPE html>
<html>
<head>
  <title>DuckDB OPFS Test</title>
</head>
<body>
  <h1>DuckDB OPFS Persistence Test</h1>
  <div id="output"></div>

  <script type="module">
    import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.30.0/+esm';

    const output = document.getElementById('output');

    function log(msg) {
      console.log(msg);
      output.innerHTML += `<div>${msg}</div>`;
    }

    async function testOPFS() {
      try {
        log('1. Selecting bundle...');
        const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
        const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

        log('2. Creating worker...');
        const worker = new Worker(bundle.mainWorker);

        log('3. Creating DuckDB instance...');
        const logger = new duckdb.ConsoleLogger();
        const db = new duckdb.AsyncDuckDB(logger, worker);

        log('4. Instantiating WASM...');
        await db.instantiate(bundle.mainModule);

        log('5. Testing db.open() API...');
        try {
          await db.open({
            path: 'test.db',
            query: { castBigIntToDouble: true }
          });
          log('✅ db.open() succeeded!');
        } catch (err) {
          log(`❌ db.open() failed: ${err.message}`);
          log('Trying alternative approach...');
        }

        log('6. Connecting...');
        const conn = await db.connect();

        log('7. Creating test table...');
        await conn.query(`
          CREATE TABLE test_persistence AS
          SELECT 'Hello OPFS' as message, CURRENT_TIMESTAMP as ts
        `);

        log('8. Querying...');
        const result = await conn.query('SELECT * FROM test_persistence');
        const data = result.toArray().map(row => row.toJSON());
        log(`Result: ${JSON.stringify(data)}`);

        log('✅ Test completed!');

      } catch (error) {
        log(`❌ Error: ${error.message}`);
        console.error(error);
      }
    }

    testOPFS();
  </script>
</body>
</html>
